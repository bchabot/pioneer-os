{% extends "base.html" %}

{% block content %}
<h2>Network Management</h2>

<div class="row">
    <!-- Hotspot Config -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-wifi"></i> Hotspot Settings
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label>Status</label>
                    <div class="d-flex align-items-center">
                        {% if hotspot_active %}
                            <span class="badge bg-success me-2">Active</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="sendAction('toggle_hotspot')">Turn Off</button>
                        {% else %}
                            <span class="badge bg-secondary me-2">Inactive</span>
                            <button class="btn btn-sm btn-outline-success" onclick="sendAction('toggle_hotspot')">Turn On</button>
                        {% endif %}
                    </div>
                </div>
                <form onsubmit="event.preventDefault(); updateHotspot();">
                    <div class="mb-2">
                        <label>SSID</label>
                        <input type="text" id="hs_ssid" class="form-control" placeholder="PIONEER_SETUP" required>
                    </div>
                    <div class="mb-3">
                        <label>Password (min 8 chars)</label>
                        <input type="password" id="hs_pass" class="form-control" placeholder="********" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update & Restart Hotspot</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Interface Info -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <i class="fas fa-network-wired"></i> Interface Status
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>IP</th>
                                <th>State</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for iface in interfaces %}
                            <tr>
                                <td>{{ iface.name }}<br><small class="text-muted">{{ iface.mac }}</small></td>
                                <td>{{ iface.ip }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if iface.state == 'up' or iface.state == 'UP' else 'secondary' }}">
                                        {{ iface.state }}
                                    </span>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3">No interfaces found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- DHCP Leases -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-users"></i> Connected Devices (DHCP)
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Hostname</th>
                                <th>IP Address</th>
                                <th>MAC Address</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for lease in leases %}
                            <tr>
                                <td>{{ lease.hostname }}</td>
                                <td>{{ lease.ip }}</td>
                                <td>{{ lease.mac }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                        onclick="prefillDHCP('{{ lease.mac }}', '{{ lease.ip }}', '{{ lease.hostname }}')">
                                        Reserve
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4">No active leases found.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- DHCP Reservations -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-thumbtack"></i> DHCP Reservations
            </div>
            <div class="card-body">
                <p class="small text-muted">Assign fixed IPs to MAC addresses.</p>
                <div class="table-responsive mb-3" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>MAC</th>
                                <th>IP</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for res in dhcp_reservations %}
                            <tr>
                                <td>{{ res.mac }}</td>
                                <td>{{ res.ip }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger py-0" onclick="deleteDHCP('{{ res.mac }}')">&times;</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <h6>Add Reservation</h6>
                <form id="dhcpForm" onsubmit="event.preventDefault(); addDHCP();">
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" id="dhcp_mac" class="form-control form-control-sm" placeholder="MAC Address" required>
                        </div>
                        <div class="col-6">
                            <input type="text" id="dhcp_ip" class="form-control form-control-sm" placeholder="IP Address" required>
                        </div>
                    </div>
                    <div class="mt-2">
                        <input type="text" id="dhcp_hostname" class="form-control form-control-sm" placeholder="Hostname (Optional)">
                    </div>
                    <button type="submit" class="btn btn-success btn-sm w-100 mt-2">Save DHCP</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Local DNS Records -->
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <i class="fas fa-globe"></i> Local DNS Records
            </div>
            <div class="card-body">
                 <p class="small text-muted">Map hostnames to IPs (no MAC required).</p>
                <div class="table-responsive mb-3" style="max-height: 200px; overflow-y: auto;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Hostname</th>
                                <th>IP</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rec in dns_records %}
                            <tr>
                                <td>{{ rec.hostname }}</td>
                                <td>{{ rec.ip }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger py-0" onclick="deleteDNS('{{ rec.hostname }}')">&times;</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <h6>Add DNS Record</h6>
                <form id="dnsForm" onsubmit="event.preventDefault(); addDNS();">
                    <div class="row g-2">
                        <div class="col-6">
                            <input type="text" id="dns_hostname" class="form-control form-control-sm" placeholder="Hostname" required>
                        </div>
                        <div class="col-6">
                            <input type="text" id="dns_ip" class="form-control form-control-sm" placeholder="IP Address" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm w-100 mt-2">Save DNS</button>
                </form>
            </div>
        </div>
    </div>

    <!-- System Settings -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <i class="fas fa-cogs"></i> System Settings
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                         <form onsubmit="event.preventDefault(); updateHostname();" class="mb-4">
                            <label>System Hostname</label>
                            <div class="input-group">
                                <input type="text" id="sys_hostname" class="form-control" placeholder="pioneer-node" required>
                                <button class="btn btn-outline-secondary" type="submit">Set</button>
                            </div>
                            <small class="text-muted">Requires reboot.</small>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <form onsubmit="event.preventDefault(); updatePassword();">
                            <label>Admin Password</label>
                            <div class="input-group">
                                <input type="password" id="sys_password" class="form-control" placeholder="New Password" required>
                                <button class="btn btn-outline-danger" type="submit">Change</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function prefillDHCP(mac, ip, hostname) {
        document.getElementById('dhcp_mac').value = mac;
        document.getElementById('dhcp_ip').value = ip;
        document.getElementById('dhcp_hostname').value = hostname;
        document.getElementById('dhcp_mac').focus();
    }

    function apiCall(cmd, data) {
        // Use relative path 'api/action'
        return fetch('api/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({command: cmd, data: data})
        })
        .then(response => {
            if (response.redirected) {
                // Fetch followed a redirect (likely to login page)
                window.location.href = response.url;
                throw new Error("Session expired. Redirecting...");
            }
            
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json().then(res => {
                    if(res.status === 'success') {
                        return res;
                    } else {
                        throw new Error(res.message || res.status);
                    }
                });
            } else {
                // Handle non-JSON response (e.g. HTML error page or login page)
                return response.text().then(text => {
                    if (text.includes("<!DOCTYPE html>") || text.includes("<html")) {
                         alert("Session expired or server error. Reloading page.");
                         window.location.reload();
                         throw new Error("Session expired");
                    }
                    throw new Error("Server Error: " + text.substring(0, 100));
                });
            }
        });
    }

    function addDHCP() {
        const btn = document.querySelector('#dhcpForm button');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Saving...";

        const data = {
            mac: document.getElementById('dhcp_mac').value,
            ip: document.getElementById('dhcp_ip').value,
            hostname: document.getElementById('dhcp_hostname').value
        };

        apiCall('add_dhcp_reservation', data)
            .then(() => location.reload())
            .catch(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerText = originalText;
            });
    }

    function deleteDHCP(mac) {
        if(confirm('Delete reservation for ' + mac + '?')) {
            apiCall('del_dhcp_reservation', {mac: mac})
                .then(() => location.reload())
                .catch(err => alert('Error: ' + err.message));
        }
    }

    function addDNS() {
        const btn = document.querySelector('#dnsForm button');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "Saving...";

        const data = {
            hostname: document.getElementById('dns_hostname').value,
            ip: document.getElementById('dns_ip').value
        };

        apiCall('add_dns_record', data)
            .then(() => location.reload())
            .catch(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerText = originalText;
            });
    }

    function deleteDNS(hostname) {
         if(confirm('Delete DNS record for ' + hostname + '?')) {
            apiCall('del_dns_record', {hostname: hostname})
                .then(() => location.reload())
                .catch(err => alert('Error: ' + err.message));
        }
    }

    function updateHotspot() {
        const data = {
            ssid: document.getElementById('hs_ssid').value,
            password: document.getElementById('hs_pass').value
        };
        if(confirm('Update hotspot settings? This will disconnect current clients.')) {
            apiCall('update_hotspot', data)
                .then(() => alert('Hotspot updated. Please reconnect.'))
                .catch(err => alert('Error: ' + err.message));
        }
    }

    function updateHostname() {
        const name = document.getElementById('sys_hostname').value;
        if(confirm('Change hostname to ' + name + '?')) {
            apiCall('set_hostname', {hostname: name})
                .then(res => {
                    alert(res.message);
                    location.reload();
                })
                .catch(err => alert('Error: ' + err.message));
        }
    }

    function updatePassword() {
        const pass = document.getElementById('sys_password').value;
        if(confirm('Change admin password?')) {
            apiCall('update_password', {password: pass})
                .then(() => {
                    alert('Password changed. Please login again.');
                    location.href = '/logout';
                })
                .catch(err => alert('Error: ' + err.message));
        }
    }
</script>
{% endblock %}